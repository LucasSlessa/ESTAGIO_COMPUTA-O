<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de MÃ©dia MÃ³vel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
    
    <div class="container">
        <div class="card">
            <h1>Calculadora de MÃ©dia MÃ³vel</h1>
            
            <div class="method-selection">
                <div class="radio-group">
                    <input type="radio" id="simples" name="metodo" value="simples" checked onchange="toggleWeights()">
                    <label for="simples">MÃ©dia MÃ³vel Simples</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="ponderada" name="metodo" value="ponderada" onchange="toggleWeights()">
                    <label for="ponderada">MÃ©dia MÃ³vel Ponderada</label>
                </div>
            </div>
            
            <div class="controls">
                <input type="number" id="periodos" placeholder="NÃºmero de perÃ­odos" min="1" onchange="updateWeights()">
                <button onclick="adicionarLinha()">Adicionar PerÃ­odo</button>
                <button onclick="calcularMediaMovel()">Calcular MÃ©dia MÃ³vel</button>
                <button onclick="limparDados()">Limpar Dados</button>
            </div>

            <div id="weightsContainer" class="weights-container">
                <h3>Pesos dos perÃ­odos (do mais recente para o mais antigo):</h3>
                <div id="weightInputs"></div>
            </div>

            <div class="table-container">
                <table id="dadosTabela">
                    <thead>
                        <tr>
                            <th>PerÃ­odo</th>
                            <th>Valor</th>
                            <th>MÃ©dia MÃ³vel</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="chart-container">
                <canvas id="grafico"></canvas>
            </div>
        </div>
    </div>

    <script>
        let chart = null;

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            atualizarGrafico();
        }

        function toggleWeights() {
            const weightsContainer = document.getElementById('weightsContainer');
            const isPonderada = document.getElementById('ponderada').checked;
            weightsContainer.classList.toggle('visible', isPonderada);
            if (isPonderada) {
                updateWeights();
            }
        }

        function updateWeights() {
            const numPeriodos = parseInt(document.getElementById('periodos').value) || 0;
            const weightInputs = document.getElementById('weightInputs');
            weightInputs.innerHTML = '';

            if (numPeriodos > 0) {
                for (let i = 0; i < numPeriodos; i++) {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = '0.1';
                    input.value = (numPeriodos - i);
                    input.className = 'weight-input';
                    input.placeholder = `Peso ${i + 1}`;
                    weightInputs.appendChild(input);
                }
            }
        }

        function adicionarLinha() {
            const tbody = document.querySelector('#dadosTabela tbody');
            const novaLinha = document.createElement('tr');
            const periodo = tbody.children.length + 1;
            
            novaLinha.innerHTML = `
                <td>${periodo}</td>
                <td><input type="number" step="0.01" onchange="atualizarGrafico()"></td>
                <td>-</td>
            `;
            
            tbody.appendChild(novaLinha);
            atualizarGrafico();
        }

        function calcularMediaMovel() {
            const numPeriodos = parseInt(document.getElementById('periodos').value);
            if (!numPeriodos || numPeriodos < 1) {
                alert('Por favor, insira um nÃºmero vÃ¡lido de perÃ­odos');
                return;
            }

            const isPonderada = document.getElementById('ponderada').checked;
            const tbody = document.querySelector('#dadosTabela tbody');
            const valores = Array.from(tbody.querySelectorAll('input')).map(input => parseFloat(input.value));

            for (let i = 0; i < valores.length; i++) {
                if (i < numPeriodos - 1) {
                    tbody.children[i].children[2].textContent = '-';
                    continue;
                }

                let mediaMovel;
                if (isPonderada) {
                    const pesos = Array.from(document.querySelectorAll('.weight-input')).map(input => parseFloat(input.value));
                    const somaPesos = pesos.reduce((acc, val) => acc + val, 0);
                    
                    let somaPonderada = 0;
                    for (let j = 0; j < numPeriodos; j++) {
                        somaPonderada += valores[i - j] * pesos[j];
                    }
                    mediaMovel = somaPonderada / somaPesos;
                } else {
                    mediaMovel = valores
                        .slice(i - numPeriodos + 1, i + 1)
                        .reduce((acc, val) => acc + val, 0) / numPeriodos;
                }

                tbody.children[i].children[2].textContent = mediaMovel.toFixed(2);
            }

            atualizarGrafico();
        }

        function limparDados() {
            document.querySelector('#dadosTabela tbody').innerHTML = '';
            document.getElementById('periodos').value = '';
            document.getElementById('weightInputs').innerHTML = '';
            if (chart) {
                chart.destroy();
                chart = null;
            }
        }

        function atualizarGrafico() {
            const ctx = document.getElementById('grafico').getContext('2d');
            const tbody = document.querySelector('#dadosTabela tbody');
            
            const periodos = Array.from(tbody.children).map((row, index) => `PerÃ­odo ${index + 1}`);
            const valores = Array.from(tbody.querySelectorAll('input')).map(input => parseFloat(input.value) || 0);
            const medias = Array.from(tbody.children).map(row => {
                const mediaText = row.children[2].textContent;
                return mediaText === '-' ? null : parseFloat(mediaText);
            });

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: periodos,
                    datasets: [{
                        label: 'Valores',
                        data: valores,
                        borderColor: '#007bff',
                        tension: 0.1
                    }, {
                        label: 'MÃ©dia MÃ³vel',
                        data: medias,
                        borderColor: '#28a745',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: document.body.classList.contains('dark-mode') ? '#fff' : '#333'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: document.body.classList.contains('dark-mode') ? 
                                    'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: document.body.classList.contains('dark-mode') ? '#fff' : '#333'
                            }
                        },
                        x: {
                            grid: {
                                color: document.body.classList.contains('dark-mode') ? 
                                    'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: document.body.classList.contains('dark-mode') ? '#fff' : '#333'
                            }
                        }
                    }
                }
            });
        }

        // Adicionar algumas linhas iniciais
        for (let i = 0; i < 5; i++) {
            adicionarLinha();
        }
    </script>
</body>
</html>